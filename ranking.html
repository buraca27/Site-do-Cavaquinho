<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <title>Ranking do Bot do Cavaquinho</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background: #181a1b;
        color: #e0e0e0;
      }
      h1 {
        color: #7fffd4;
        text-align: center;
      }
      table {
        border-collapse: collapse;
        width: 100%;
        max-width: 700px;
        margin: 2rem auto;
        background: #23272a;
      }
      th,
      td {
        border: 1px solid #333;
        padding: 8px 12px;
      }
      th {
        background: #222e26;
        color: #7fffd4;
      }
      tr:nth-child(even) {
        background: #23272a;
      }
      tr:nth-child(odd) {
        background: #181a1b;
      }
      .searchbar {
        display: flex;
        justify-content: center;
        margin: 2rem 0 1rem 0;
      }
      .searchbar input {
        padding: 8px 12px;
        border-radius: 4px;
        border: 1px solid #444;
        background: #23272a;
        color: #e0e0e0;
        width: 250px;
      }
      .searchbar button {
        padding: 8px 16px;
        border-radius: 4px;
        border: none;
        background: #7fffd4;
        color: #181a1b;
        font-weight: bold;
        cursor: pointer;
        margin-left: 8px;
      }
      .notfound {
        color: #ff6b6b;
        text-align: center;
      }
      .user-stats-modal {
        display: none;
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.7);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }
      .user-stats-content {
        background: #23272a;
        color: #e0e0e0;
        padding: 2rem 2.5rem;
        border-radius: 10px;
        min-width: 300px;
        max-width: 90vw;
        box-shadow: 0 0 20px #000;
        text-align: center;
        position: relative;
      }
      .user-stats-content h2 {
        color: #7fffd4;
        margin-bottom: 1rem;
      }
      .user-stats-content button {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #7fffd4;
        color: #181a1b;
        border: none;
        border-radius: 4px;
        font-weight: bold;
        padding: 4px 10px;
        cursor: pointer;
      }
      .user-stats-content table {
        margin: 1rem auto 0 auto;
        background: none;
        border: none;
        width: auto;
      }
      .user-stats-content td {
        border: none;
        padding: 4px 12px;
        text-align: left;
      }
      .user-link {
        color: #7fffd4;
        cursor: pointer;
        text-decoration: underline;
      }
    </style>
  </head>
  <body>
    <h1>üèÜ Ranking dos Utilizadores</h1>
    <div class="searchbar">
      <input
        type="text"
        id="searchInput"
        placeholder="Procurar utilizador..."
      />
      <button onclick="searchUser()">Procurar</button>
    </div>
    <div id="notFound" class="notfound"></div>
    <table id="rankingTable">
      <tr>
        <th>#</th>
        <th>Utilizador</th>
        <th>Pontos</th>
      </tr>
      <!-- Ranking ser√° preenchido pelo JS -->
    </table>
    <p style="text-align: center">
      <a href="index.html">‚Üê Voltar √† p√°gina inicial</a>
    </p>

    <!-- Modal para estat√≠sticas do utilizador -->
    <div class="user-stats-modal" id="userStatsModal">
      <div class="user-stats-content" id="userStatsContent">
        <button onclick="closeUserStats()">X</button>
        <div id="userStatsBody">
          <!-- Conte√∫do din√¢mico -->
        </div>
      </div>
    </div>

    <script type="module">
      // Substitua pelos dados do seu projeto Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyDuMS9GHD3_zQQa5cRMUuA1YA5cjegoGDM",
        authDomain: "bot-cavaquinho.firebaseapp.com",
        projectId: "bot-cavaquinho",
      };

      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
      import {
        getFirestore,
        collection,
        getDocs,
        doc,
        getDoc
      } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore.js";

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      let rankingData = [];

      async function carregarRanking() {
        const snapshot = await getDocs(collection(db, "points"));
        rankingData = [];
        snapshot.forEach((docSnap) => {
          const data = docSnap.data();
          const userId = docSnap.id.toLowerCase();
          // Filtra cavaquiinho30 e ecoponto30
          if (userId !== "cavaquiinho30" && userId !== "ecoponto30") {
            rankingData.push({ user: docSnap.id, points: data.points || 0 });
          }
        });
        // Ordena por pontos decrescente
        rankingData.sort((a, b) => b.points - a.points);
        renderRanking(rankingData);
      }

      function renderRanking(data) {
        const table = document.getElementById("rankingTable");
        // Remove todas as linhas exceto o header
        while (table.rows.length > 1) table.deleteRow(1);
        data.forEach((item, idx) => {
          const row = table.insertRow();
          row.insertCell().textContent = idx + 1;
          const userCell = row.insertCell();
          userCell.innerHTML = `<span class="user-link" onclick="window.showUserStats('${item.user}')">${item.user}</span>`;
          row.insertCell().textContent = Math.floor(item.points);
        });
      }

      function searchUser() {
        const input = document
          .getElementById("searchInput")
          .value.trim()
          .toLowerCase();
        const notFound = document.getElementById("notFound");
        if (!input) {
          renderRanking(rankingData);
          notFound.textContent = "";
          return;
        }
        const filtered = rankingData.filter((item) =>
          item.user.toLowerCase().includes(input)
        );
        renderRanking(filtered);
        notFound.textContent =
          filtered.length === 0 ? "Utilizador n√£o encontrado." : "";
      }

      document
        .getElementById("searchInput")
        .addEventListener("input", searchUser);

      // Fun√ß√£o global para mostrar estat√≠sticas do utilizador
      window.showUserStats = async function(username) {
        const modal = document.getElementById("userStatsModal");
        const body = document.getElementById("userStatsBody");
        body.innerHTML = "<p>A carregar estat√≠sticas...</p>";
        modal.style.display = "flex";
        // Vai buscar as estat√≠sticas do utilizador
        const statsRef = doc(db, "userStats", username.toLowerCase());
        const statsSnap = await getDoc(statsRef);
        if (!statsSnap.exists()) {
          body.innerHTML = `<h2>${username}</h2><p>Sem estat√≠sticas dispon√≠veis.</p>`;
          return;
        }
        const stats = statsSnap.data();
        body.innerHTML = `
          <h2>${username}</h2>
          <table>
            <tr><td><b>Apostas:</b></td><td>${stats.apostas ?? 0}</td></tr>
            <tr><td><b>Vit√≥rias:</b></td><td>${stats.ganhos ?? 0}</td></tr>
            <tr><td><b>Derrotas:</b></td><td>${stats.perdas ?? 0}</td></tr>
            <tr><td><b>Total apostado:</b></td><td>${stats.apostado ?? 0}</td></tr>
            <tr><td><b>Pre√ßo Certo ganhos:</b></td><td>${stats.precoCerto?.ganhos ?? 0}</td></tr>
          </table>
        `;
      };

      window.closeUserStats = function() {
        document.getElementById("userStatsModal").style.display = "none";
      };

      carregarRanking();
    </script>
  </body>
</html>