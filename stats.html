<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <title>Ranking do Bot do Cavaquinho</title>
    <link rel="stylesheet" href="dark-theme.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
  <body>
    <header class="header">
      <div class="logo">üé∂ Bot do Cavaquinho</div>
      <h1>üèÜ Ranking dos Utilizadores</h1>
    </header>
    <div class="searchbar">
      <input
        type="text"
        id="searchInput"
        placeholder="Procurar utilizador..."
      />
      <button onclick="searchUser()">Procurar</button>
    </div>
    <div id="notFound" class="notfound"></div>
    <div class="table-wrapper">
      <table id="rankingTable">
        <tr>
          <th>#</th>
          <th>Utilizador</th>
          <th>Pontos</th>
        </tr>
        <!-- Ranking ser√° preenchido pelo JS -->
      </table>
    </div>
    <a href="index.html" class="back-link">‚Üê Voltar √† p√°gina inicial</a>
    <footer class="footer">
      <p>Feito com ‚ù§Ô∏è por <a href="https://twitch.tv/buraca27" target="_blank">Buraca27</a></p>
    </footer>

    <!-- Modal para estat√≠sticas do utilizador -->
    <div class="user-stats-modal" id="userStatsModal">
      <div class="user-stats-content">
        <button class="close-button" onclick="closeUserStats()">‚úï</button>
        <div id="userStatsBody">
          <!-- Conte√∫do din√¢mico -->
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
      import {
        getFirestore,
        collection,
        getDocs,
        doc,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDuMS9GHD3_zQQa5cRMUuA1YA5cjegoGDM",
        authDomain: "bot-cavaquinho.firebaseapp.com",
        projectId: "bot-cavaquinho",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      let rankingData = [];

      async function carregarRanking() {
        const snapshot = await getDocs(collection(db, "points"));
        rankingData = [];
        snapshot.forEach((docSnap) => {
          const data = docSnap.data();
          const userId = docSnap.id.toLowerCase();
          if (userId !== "cavaquiinho30" && userId !== "ecoponto30") {
            rankingData.push({ user: docSnap.id, points: data.points || 0 });
          }
        });
        rankingData.sort((a, b) => b.points - a.points);
        renderRanking(rankingData);
      }

      function renderRanking(data) {
        const table = document.getElementById("rankingTable");
        while (table.rows.length > 1) table.deleteRow(1);
        data.forEach((item, idx) => {
          const row = table.insertRow();
          row.insertCell().textContent = idx + 1;
          const userCell = row.insertCell();
          userCell.innerHTML = `<span class="user-link" onclick="window.showUserStats('${item.user}')">${item.user}</span>`;
          row.insertCell().textContent = Math.floor(item.points);
        });
      }

      function searchUser() {
        const input = document.getElementById("searchInput").value.trim().toLowerCase();
        const notFound = document.getElementById("notFound");
        if (!input) {
          renderRanking(rankingData);
          notFound.textContent = "";
          return;
        }
        const filtered = rankingData.filter((item) =>
          item.user.toLowerCase().includes(input)
        );
        renderRanking(filtered);
        notFound.textContent = filtered.length === 0 ? "Utilizador n√£o encontrado." : "";
      }

      document.getElementById("searchInput").addEventListener("input", searchUser);

      window.showUserStats = async function (username) {
        const modal = document.getElementById("userStatsModal");
        const body = document.getElementById("userStatsBody");
        body.innerHTML = "<p class='stat-value'>Carregando...</p>";
        modal.style.display = "flex";
        modal.classList.remove("loaded");
        const statsRef = doc(db, "userStats", username.toLowerCase());
        try {
          const statsSnap = await getDoc(statsRef);
          if (!statsSnap.exists()) {
            body.innerHTML = `
              <h2>${username}</h2>
              <p class="stat-value error">Sem estat√≠sticas dispon√≠veis.</p>
            `;
          } else {
            const stats = statsSnap.data();
            body.innerHTML = `
              <h2>${username}</h2>
              <div class="stats-grid">
                <div class="stat-card">
                  <span class="stat-icon">üé∞</span>
                  <h3>Apostas</h3>
                  <p class="stat-value">${stats.apostas ?? 0}</p>
                </div>
                <div class="stat-card">
                  <span class="stat-icon">üèÜ</span>
                  <h3>Vit√≥rias</h3>
                  <p class="stat-value">${stats.ganhos ?? 0}</p>
                </div>
                <div class="stat-card">
                  <span class="stat-icon">‚ùå</span>
                  <h3>Derrotas</h3>
                  <p class="stat-value">${stats.perdas ?? 0}</p>
                </div>
                <div class="stat-card">
                  <span class="stat-icon">üí∏</span>
                  <h3>Total Apostado</h3>
                  <p class="stat-value">${stats.apostado ?? 0}</p>
                </div>
                <div class="stat-card">
                  <span class="stat-icon">üèÖ</span>
                  <h3>Pre√ßo Certo Ganhos</h3>
                  <p class="stat-value">${stats.precoCerto?.ganhos ?? 0}</p>
                </div>
              </div>
            `;
          }
          modal.classList.add("loaded");
        } catch (error) {
          console.error("Erro ao carregar stats:", error);
          body.innerHTML = `
            <h2>${username}</h2>
            <p class="stat-value error">Erro ao carregar estat√≠sticas.</p>
          `;
          modal.classList.add("loaded");
        }
      };

      window.closeUserStats = function () {
        const modal = document.getElementById("userStatsModal");
        modal.classList.remove("loaded");
        setTimeout(() => {
          modal.style.display = "none";
        }, 200); // Match CSS transition duration
      };

      carregarRanking();
    </script>
  </body>
</html>